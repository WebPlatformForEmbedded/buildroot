<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>WPE</title>
<style>

@keyframes fade {
    0% { opacity: 0; }
    30% { opacity: 0; }
    90% { opacity: 1; }
    100% { opacity: 0; }
}

html, body {
    background-color: #111;
    color: #fff;
    font-family: "Bitstream Vera Sans Mono";
    margin: 0;
}

div#logo {
    position: relative;
    margin: 15% 41.5%;
    width: 12%;
}

div#logo:after {
    content: "";
    display: block;
    padding-bottom: 100%;
}

div#logo div {
    width: 45%;
    height: 45%;
}
div#logo.animate div {
    opacity: 0;
    animation: fade 3s linear infinite;
}
div#logo div:nth-of-type(1) {
    position: absolute;
    top: 2.5%;
    left: 2.5%;
    background-color: #3399ff;
}
div#logo div:nth-of-type(2) {
    position: absolute;
    top: 2.5%;
    right: 2.5%;
    animation-delay: -0.15s;
    background-color: #336699;

}
div#logo div:nth-of-type(3) {
    position: absolute;
    bottom: 2.5%;
    right: -47.5%;
    animation-delay: -0.5s;
    background-color: #66cc33;
}
div#logo div:nth-of-type(4) {
    position: absolute;
    bottom: 2.5%;
    left: 2.5%;
    animation-delay: -0.65s;
    background-color: #003366;
}

div#logo div:nth-of-type(5) {
    position: absolute;
    bottom: -47.5%;
    right: -47.5%;
    animation-delay: -0.25s;
    background-color: #006600;
}

div#logo div:nth-of-type(6) {
    position: absolute;
    bottom: -47.5%;
    right: 2.5%;
    animation-delay: -0.35s;
    background-color: #003300;
}

div#status {
    display: block;
    position: absolute;
    left: 0;
    bottom: 23%;
    right: 0;
    margin: auto;
    width: 100%;
    font-size: 280%;
    text-align: center;
}

div#interfaces {
    display: block;
    position: absolute;
    left: 0;
    bottom: 10%;
    right: 0;
    margin: auto;
    width: 100%;
    font-size: 200%;
    text-align: center;
}
</style>
</head>
<body>
<div id="logo" class="animate"><div></div><div></div><div></div><div></div><div></div><div></div></div>
<div id="status">Hello</div>
<div id="interfaces"></div>
<script>
var ThunderJS=function(){"use strict";function l(e){return(l="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function n(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(n);e&&(o=o.filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})),t.push.apply(t,o)}return t}var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},t=null;"undefined"!=typeof WebSocket?t=WebSocket:"undefined"!=typeof MozWebSocket?t=MozWebSocket:void 0!==e?t=e.WebSocket||e.MozWebSocket:"undefined"!=typeof window?t=window.WebSocket||window.MozWebSocket:"undefined"!=typeof self&&(t=self.WebSocket||self.MozWebSocket);function f(t){return new Promise(function(e,n){if(i)e(i);else try{c||((c=new r(function(e){return[e&&e.protocol||"ws://",e&&e.host||"localhost",":"+(e&&e.port||80),e&&e.endpoint||"/jsonrpc"].join("")}(t),"notification")).addEventListener("message",function(e){!function(e){if("string"==typeof e&&(e=JSON.parse(e.normalize().replace(/\\x([0-9A-Fa-f]{2})/g,""))),e.id){var n=a[e.id];n?("result"in e?n.resolve(e.result):n.reject(e.error),delete a[e.id]):console.log("no pending request found with id "+e.id)}}(e.data)}),c.addEventListener("message",function(e){!function(n){if("string"==typeof n&&(n=JSON.parse(n.normalize().replace(/\\x([0-9A-Fa-f]{2})/g,""))),!n.id&&n.method){var e=u[n.method];e&&Array.isArray(e)&&e.length?e.forEach(function(e){e(n.params)}):console.log("no callbacks for "+n.method)}}(e.data)})),c.addEventListener("open",function(){e(i=c)})}catch(e){n(e)}})}function o(s){return{request:function(i,c,u){return new Promise(function(e,n){var t=p+=1,o=function(e,n,t){var o;return(o=t&&t.version)?o:e&&(e[n]||e.default)||1}(s.versions,i,u),r=function(e,n,t,o,r){o&&delete o.version;var i={jsonrpc:"2.0",id:e,method:[n,r,t].join(".")};return!o&&!1!==o||"object"===l(o)&&0===Object.keys(o).length||(i.params=o),i}(t,i,c,u,o);s.debug&&(console.log(" "),console.log("API REQUEST:"),console.log(JSON.stringify(r,null,2)),console.log(" ")),a[t]={body:r,resolve:e,reject:n},function(e,n){f(e).then(function(e){e.send(JSON.stringify(n))}).catch(console.error)}(s,r)})}}}var r=t,a={},u={},i=null,c=null,p=0,s={DeviceInfo:{freeRam:function(e){return this.call("systeminfo",e).then(function(e){return e.freeram})},version:function(e){return this.call("systeminfo",e).then(function(e){return e.version})}}};function d(n,t,e){var o=this,r=function(e,n,t){var o=y(e,n);if(!u[o]){u[o]=[];var r="register";var i=o.split(".").slice(0,-1).join(".");var c={event:n,id:i};this.api.request(e,r,c).then().catch()}return u[o].push(t),u[o].length-1}.call(this,n,t,e);return{dispose:function(){var e=y(n,t);u[e].splice(r,1),0===u[e].length&&function(e,n){var t=y(e,n);delete u[t];var o="unregister",r=t.split(".").slice(0,-1).join("."),i={event:n,id:r};this.api.request(e,o,i)}.call(o,n,t)}}}function y(e,n){return["client",e,"events",n].join(".")}var h,g=function t(e){return{options:e,plugin:!1,call:function(){var e=Array.prototype.slice.call(arguments);this.plugin&&e[0]!==this.plugin&&e.unshift(this.plugin);var n=e[0],t=e[1];return"function"==typeof this[n][t]?this[n][t](e[2]):this.api.request.apply(this,e)},registerPlugin:function(e,n){this[e]=b(Object.assign(Object.create(t),n,{plugin:e}))},subscribe:function(){},on:function(){var e=Array.prototype.slice.call(arguments);return this.plugin&&e[0]!==this.plugin&&e.unshift(this.plugin),d.apply(this,e)},once:function(){console.log("todo ...")}}},b=function e(n){return new Proxy(n,{get:function(o,r){var i=o[r];return"api"===r?h:void 0!==i?"function"==typeof i?-1<["on","once","subscribe"].indexOf(r)?function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];return i.apply(this,n)}:function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];return function(t,e){"object"===l(t)&&("object"!==l(t)||t.then&&"function"==typeof t.then)||(t=new Promise(function(e,n){t instanceof Error==!1?e(t):n(t)}));var n="function"==typeof e[e.length-1]?e[e.length-1]:null;if(!n)return t;t.then(function(e){return n(null,e)}).catch(function(e){return n(e)})}(i.apply(this,n),n)}:"object"===l(i)?e(Object.assign(Object.create(g(o.options)),i,{plugin:r})):i:!1===o.plugin?e(Object.assign(Object.create(g(o.options)),{},{plugin:r})):function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];return n.unshift(r),o.call.apply(this,n)}}})};return function(e){return h=o(e),b(function(r){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?n(i,!0).forEach(function(e){var n,t,o;n=r,o=i[t=e],t in n?Object.defineProperty(n,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):n[t]=o}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(i)):n(i).forEach(function(e){Object.defineProperty(r,e,Object.getOwnPropertyDescriptor(i,e))})}return r}({},g(e),{},s))}}();
</script>
<script type="text/javascript">
    (function (host) {
        const logoEl = document.getElementById('logo'),
            statusEl = document.getElementById('status'),
            interfacesEl = document.getElementById('interfaces'),
            thunderJS = ThunderJS({host: host})
        let deviceid
        function delay(t, v) {
           return new Promise((resolve) => {
               setTimeout(resolve.bind(null, v), t)
           })
        }
        function log(interfaces) {
            return new Promise((resolve, reject) => {
                var ip = ''
                for (var i = 0; i < interfaces.length; i++)
                    ip += `${interfaces[i].name}: ${interfaces[i].ip}<br/>`
                if (ip !== '') interfacesEl.innerHTML = ip
                resolve(interfaces)
            })
        }
        function interfaces() {
            return new Promise((resolve, reject) => {
                thunderJS.call('DeviceInfo', 'systeminfo').then((systeminfo) => {
                    deviceId = systeminfo.deviceid ? systeminfo.deviceid : ''

                    thunderJS.call('DeviceInfo', 'addresses').then( (addresses) => {
                        let result = addresses.filter( a => {
                            if (a.ip && a.ip.length && a.ip[0] !== '127.0.0.1')
                                return true
                        })
                        resolve(result)
                    })
                })
            })
        }
        function xhr(method, url, body) {
            return new Promise((resolve, reject) => {
                var http = new XMLHttpRequest();
                http.onreadystatechange = (event) => {
                    var req = event.target;
                    if (req.readyState == 4) {
                        if (req.status == 200) {
                            try {
                                resolve(method === 'GET' ? JSON.parse(req.responseText) : undefined);
                            } catch(err) {
                                reject(err);
                            }
                        } else {
                            reject('XHR failed');
                        }

                    }
                };
                http.open(method || 'GET', url, true);
                http.send(body);
            });
        }
        function configUX() {
            return xhr('GET', '/config.json');
        }
        function loadUX(config) {
            return new Promise((resolve, reject) => {
                var id = encodeURIComponent(deviceId)
                xhr('GET', `${config.ux}${id}`)
                    .then((result) => {
                        if (result && result.url) {
                            let loadUXListener = thunderJS.on('Controller', 'all', (data) => {
                                if (data.callsign !== 'UX')
                                    return;

                                let _data = data.data ? data.data : {};

                                if (_data.state === 'activated')
                                    thunderjs.call('UX', 'url',  url)
                                    .then(  thunderjs.call('UX', 'state', 'resumed') )

                                if (_data.url && _data.loaded) {
                                    delay(5000).then( () => {
                                        thunderJS.call('Controller', 'deactivate', { callsign: 'WebKitBrowser' } )
                                    })
                                    resolve()
                                }
                            })

                            thunderJS.call('Controller', 'activate', { callsign : 'UX'})
                        } else {
                            reject()
                        }
                    })
                    .catch(reject)
            });
        }
        return new Promise((resolve, reject) => {
            let subsystemNotificationListener = thunderJS.on('Controller', 'subsystemchange', (data) => {
                console.log(data)

                data.map( d => {
                    if (d.subsystem && d.active && d.subsystem === 'Internet')
                        statusEl.innerHTML = 'We&#39;re connected!';

                    if (d.subsystem && d.active && d.subsystem === 'Network') {
                        statusEl.innerHTML = 'Waiting for connection'
                        interfaces().then(log);
                    }

                    if (d.subsystem && d.active && d.subsystem === 'Time') {
                        statusEl.innerHTML = 'Internet is up!';
                        configUX()
                            .then((config) => {
                                statusEl.innerHTML = 'Loading UX';
                                loadUX(config).then(() => {
                                    logoEl.className = '';
                                    statusEl.innerHTML = 'We&#39;re ready!';
                                })
                                .catch((err) => {
                                    statusEl.innerHTML = 'Something went wrong (' + deviceId + ')';
                                })
                            })
                            .catch((err) => {
                                    logoEl.className = '';
                                    statusEl.innerHTML = 'We&#39;re ready!';
                            })
                    }
                })
            })

            let networkNotificationListener = thunderJS.on('Controller', 'all', (data) => {
                if (data.callsign !== 'NetworkControl')
                    return;

                if (data.data.running)
                    statusEl.innerHTML = `Acquiring Network (${data.data.interface})`;
                else if (data.data.status === 11)
                    delay(2000)
                        .then( thunderJS.call('NetworkControl', 'request', { device:  data.data.interface} ) )
                        .catch(reject);
            })

            //fix me, thunderjs needs a connected event
            delay(400).then( interfaces().then(log) )
        });
    }(location.hostname)).catch(console.error)
</script>
</body>
</html>
